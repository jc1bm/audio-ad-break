<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ad In Situ Maker</title>
</head>
<body>
  <h1>Ad In Situ Maker1</h1>

  <!-- Your existing dropdowns -->
  <div id="selectors">
    <!-- Station In -->
    <select id="station_in">
      <option value="audio/station/absolute.wav">Absolute</option>
      <option value="audio/station/sting2.wav">Sting 2</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <!-- Gap and Ad Selects -->
    <select id="gap0">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br /><br />

    <select id="ad1">
      <option value="audio/ad/ad1.wav">Ad 1</option>
      <option value="audio/ad/ad2.wav">Ad 2</option>
      <option value="audio/ad/ad3.wav">Ad 3</option>
      <option value="audio/ad/ad4.wav">Ad 4</option>
      <option value="audio/ad/ad5.wav">Ad 5</option>
      <option value="audio/ad/ad6.wav">Ad 6</option>
      <option value="audio/ad/ad7.wav">Ad 7</option>
      <option value="audio/ad/ad8.wav">Ad 8</option>
      <option value="audio/ad/none.wav">None</option>
      <option value="audio/ad/target.wav">Target Wav</option>
    </select>

    <select id="gap1">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br />

    <select id="ad2">
      <option value="audio/ad/ad2.wav">Ad 2</option>
      <option value="audio/ad/ad1.wav">Ad 1</option>
      <option value="audio/ad/ad3.wav">Ad 3</option>
      <option value="audio/ad/ad4.wav">Ad 4</option>
      <option value="audio/ad/ad5.wav">Ad 5</option>
      <option value="audio/ad/ad6.wav">Ad 6</option>
      <option value="audio/ad/ad7.wav">Ad 7</option>
      <option value="audio/ad/ad8.wav">Ad 8</option>
      <option value="audio/ad/none.wav">None</option>
      <option value="audio/ad/target.wav">Target Wav</option>
    </select>

    <select id="gap2">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br />

    <select id="ad3">
      <option value="audio/ad/ad3.wav">Ad 3</option>
      <option value="audio/ad/ad2.wav">Ad 2</option>
      <option value="audio/ad/ad1.wav">Ad 1</option>
      <option value="audio/ad/ad4.wav">Ad 4</option>
      <option value="audio/ad/ad5.wav">Ad 5</option>
      <option value="audio/ad/ad6.wav">Ad 6</option>
      <option value="audio/ad/ad7.wav">Ad 7</option>
      <option value="audio/ad/ad8.wav">Ad 8</option>
      <option value="audio/ad/none.wav">None</option>
      <option value="audio/ad/target.wav">Target Wav</option>
    </select>

    <select id="gap3">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br />

    <select id="ad4">
      <option value="audio/ad/ad4.wav">Ad 4</option>
      <option value="audio/ad/ad2.wav">Ad 2</option>
      <option value="audio/ad/ad3.wav">Ad 3</option>
      <option value="audio/ad/ad1.wav">Ad 1</option>
      <option value="audio/ad/ad5.wav">Ad 5</option>
      <option value="audio/ad/ad6.wav">Ad 6</option>
      <option value="audio/ad/ad7.wav">Ad 7</option>
      <option value="audio/ad/ad8.wav">Ad 8</option>
      <option value="audio/ad/none.wav">None</option>
      <option value="audio/ad/target.wav">Target Wav</option>
    </select>

    <select id="gap4">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br />

    <select id="ad5">
      <option value="audio/ad/ad5.wav">Ad 5</option>
      <option value="audio/ad/ad2.wav">Ad 2</option>
      <option value="audio/ad/ad3.wav">Ad 3</option>
      <option value="audio/ad/ad4.wav">Ad 4</option>
      <option value="audio/ad/ad5.wav">Ad 1</option>
      <option value="audio/ad/ad6.wav">Ad 6</option>
      <option value="audio/ad/ad7.wav">Ad 7</option>
      <option value="audio/ad/ad8.wav">Ad 8</option>
      <option value="audio/ad/none.wav">None</option>
      <option value="audio/ad/target.wav">Target Wav</option>
    </select>

    <select id="gap5">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br />

    <select id="ad6">
      <option value="audio/ad/ad6.wav">Ad 6</option>
      <option value="audio/ad/ad2.wav">Ad 2</option>
      <option value="audio/ad/ad3.wav">Ad 3</option>
      <option value="audio/ad/ad4.wav">Ad 4</option>
      <option value="audio/ad/ad5.wav">Ad 5</option>
      <option value="audio/ad/ad6.wav">Ad 1</option>
      <option value="audio/ad/ad7.wav">Ad 7</option>
      <option value="audio/ad/ad8.wav">Ad 8</option>
      <option value="audio/ad/none.wav">None</option>
      <option value="audio/ad/target.wav">Target Wav</option>
    </select>

    <select id="gap6">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br />

    <select id="ad7">
      <option value="audio/ad/ad7.wav">Ad 7</option>
      <option value="audio/ad/ad2.wav">Ad 2</option>
      <option value="audio/ad/ad3.wav">Ad 3</option>
      <option value="audio/ad/ad4.wav">Ad 4</option>
      <option value="audio/ad/ad5.wav">Ad 5</option>
      <option value="audio/ad/ad6.wav">Ad 6</option>
      <option value="audio/ad/ad7.wav">Ad 1</option>
      <option value="audio/ad/ad8.wav">Ad 8</option>
      <option value="audio/ad/none.wav">None</option>
      <option value="audio/ad/target.wav">Target Wav</option>
    </select>

    <select id="gap7">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br /><br />

    <!-- Station Out -->
    <select id="station_out">
      <option value="audio/station/absolute.wav">Absolute</option>
      <option value="audio/station/sting2.wav">Sting 2</option>
      <option value="audio/ad/none.wav">None</option>
    </select>
  </div>

  <br />
  <label for="videoImage">Select Image for Video:</label>
  <select id="videoImage">
    <option value="images/absolute.jpg">Absolute</option>
    <option value="images/cover1.jpg">Cover 1</option>
    <option value="images/cover2.jpg">Cover 2</option>
  </select>

  <br /><br />

  <button id="exportAudio">Export Audio</button>
  <button id="exportVideo">Export Video</button>

  <br><br>
<button id="playSequence">Play Sequence</button>
<br><br>
<audio id="previewPlayer" controls style="width: 100%;"></audio>
  <br><br>
<button id="playSequenceVideo">Preview Video</button>
    <br><br>
<video id="previewVideo" width="640" height="360" controls muted></video>

<script>
function getAudioContext() {
  if (!window.audioCtx) {
    window.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  return window.audioCtx;
}

  async function buildSequence(context) {
  const dropdowns = document.querySelectorAll(".clip-dropdown");
  const selectedUrls = Array.from(dropdowns)
    .map(dropdown => dropdown.value)
    .filter(url => url); // skip empty

  const buffers = await Promise.all(
    selectedUrls.map(async (url) => {
      const response = await fetch(url);
      const arrayBuffer = await response.arrayBuffer();
      return context.decodeAudioData(arrayBuffer);
    })
  );

  // Calculate total length
  const totalLength = buffers.reduce((sum, b) => sum + b.length, 0);
  const output = context.createBuffer(1, totalLength, context.sampleRate);
  let offset = 0;

  for (const buffer of buffers) {
    output.getChannelData(0).set(buffer.getChannelData(0), offset);
    offset += buffer.length;
  }

  return output;
}
  
function downloadBlob(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.style = "display:none";
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(url);
  a.remove();
}

document.getElementById("exportAudio").addEventListener("click", async () => {
  const context = getAudioContext();
  if (!context) return;
  const buffer = await buildSequence(context);
  const wavBlob = bufferToWav(buffer);
  downloadBlob(wavBlob, "adbreak.wav");
});

document.getElementById("exportVideo").addEventListener("click", async () => {
  const context = getAudioContext();
  if (!context) return;

  const buffer = await buildSequence(context);
  const selectedImage = document.getElementById("videoImage").value;

  const canvas = document.createElement("canvas");
  canvas.width = 1280;
  canvas.height = 720;
  const ctx = canvas.getContext("2d");

  const image = new Image();
  image.crossOrigin = "anonymous";
  image.src = selectedImage;

  await new Promise((resolve, reject) => {
    image.onload = () => {
      ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
      resolve();
    };
    image.onerror = reject;
  });

  const canvasStream = canvas.captureStream(30);
  const dest = context.createMediaStreamDestination();
  const source = context.createBufferSource();
  source.buffer = buffer;
  source.connect(dest);
  source.start();
  const audioStream = dest.stream;

  const combinedStream = new MediaStream([
    ...canvasStream.getVideoTracks(),
    ...audioStream.getAudioTracks()
  ]);

  const recorder = new MediaRecorder(combinedStream, {
    mimeType: "video/webm"
  });

  const chunks = [];
  recorder.ondataavailable = (e) => chunks.push(e.data);
  recorder.onstop = () => {
    const blob = new Blob(chunks, { type: "video/webm" });
    downloadBlob(blob, "adbreak.webm");
  };

  recorder.start();

  setTimeout(() => {
    recorder.stop();
  }, (buffer.duration + 0.2) * 1000); // add a bit of padding
});

// AUDIO preview only
document.getElementById('playSequence').addEventListener('click', async () => {
  const context = getAudioContext();
  const buffer = await buildSequence(context);
  const wavBlob = bufferToWav(buffer);
  const audioURL = URL.createObjectURL(wavBlob);

  const audioPlayer = document.getElementById('previewPlayer');
  audioPlayer.src = audioURL;
  audioPlayer.play();
});

// VIDEO preview
document.getElementById('playSequenceVideo').addEventListener('click', async () => {
  const context = getAudioContext();
  const buffer = await buildSequence(context);
  const selectedImage = document.getElementById("videoImage").value;

  const canvas = document.createElement("canvas");
  canvas.width = 1280;
  canvas.height = 720;
  const ctx = canvas.getContext("2d");

  const image = new Image();
  image.crossOrigin = "anonymous";
  image.src = selectedImage;

  await new Promise((resolve, reject) => {
    image.onload = () => {
      ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
      resolve();
    };
    image.onerror = reject;
  });

  const canvasStream = canvas.captureStream(30);
  const dest = context.createMediaStreamDestination();
  const source = context.createBufferSource();
  source.buffer = buffer;
  source.connect(dest);
  source.start();

  const audioStream = dest.stream;

  const combinedStream = new MediaStream([
    ...canvasStream.getVideoTracks(),
    ...audioStream.getAudioTracks()
  ]);

  const videoElement = document.getElementById("previewVideo");
  videoElement.srcObject = combinedStream;
  videoElement.play();

  // Stop the video stream after buffer duration
  setTimeout(() => {
    source.stop();
    videoElement.srcObject = null;
  }, (buffer.duration + 0.2) * 1000);
});
</script>

</body> </html>
