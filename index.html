<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ad In Situ Maker1</title>
<link href="//vjs.zencdn.net/8.23.3/video-js.min.css" rel="stylesheet">
<script src="//vjs.zencdn.net/8.23.3/video.min.js"></script>
</head>
<body>
  <h1>Ad In Situ Maker1</h1>

  <!-- Your existing dropdowns -->
  <div id="selectors">
    <!-- Station In -->
    <select id="station_in" class="clip-dropdown">
      <option value="audio/station/absolute.wav">Absolute</option>
      <option value="audio/station/sting2.wav">Sting 2</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <!-- Gap and Ad Selects -->
    <select id="gap0" class="clip-dropdown">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br /><br />

    <select id="ad1"> class="clip-dropdown">
      <option value="audio/ad/ad1.wav">Ad 1</option>
      <option value="audio/ad/ad2.wav">Ad 2</option>
      <option value="audio/ad/ad3.wav">Ad 3</option>
      <option value="audio/ad/ad4.wav">Ad 4</option>
      <option value="audio/ad/ad5.wav">Ad 5</option>
      <option value="audio/ad/ad6.wav">Ad 6</option>
      <option value="audio/ad/ad7.wav">Ad 7</option>
      <option value="audio/ad/ad8.wav">Ad 8</option>
      <option value="audio/ad/none.wav">None</option>
      <option value="audio/ad/target.wav">Target Wav</option>
    </select>

    <select id="gap1" class="clip-dropdown">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br />

    <select id="ad2" class="clip-dropdown">
      <option value="audio/ad/ad2.wav">Ad 2</option>
      <option value="audio/ad/ad1.wav">Ad 1</option>
      <option value="audio/ad/ad3.wav">Ad 3</option>
      <option value="audio/ad/ad4.wav">Ad 4</option>
      <option value="audio/ad/ad5.wav">Ad 5</option>
      <option value="audio/ad/ad6.wav">Ad 6</option>
      <option value="audio/ad/ad7.wav">Ad 7</option>
      <option value="audio/ad/ad8.wav">Ad 8</option>
      <option value="audio/ad/none.wav">None</option>
      <option value="audio/ad/target.wav">Target Wav</option>
    </select>

    <select id="gap2" class="clip-dropdown">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br />

    <select id="ad3" class="clip-dropdown">
      <option value="audio/ad/ad3.wav">Ad 3</option>
      <option value="audio/ad/ad2.wav">Ad 2</option>
      <option value="audio/ad/ad1.wav">Ad 1</option>
      <option value="audio/ad/ad4.wav">Ad 4</option>
      <option value="audio/ad/ad5.wav">Ad 5</option>
      <option value="audio/ad/ad6.wav">Ad 6</option>
      <option value="audio/ad/ad7.wav">Ad 7</option>
      <option value="audio/ad/ad8.wav">Ad 8</option>
      <option value="audio/ad/none.wav">None</option>
      <option value="audio/ad/target.wav">Target Wav</option>
    </select>

    <select id="gap3" class="clip-dropdown">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br />

    <select id="ad4" class="clip-dropdown">
      <option value="audio/ad/ad4.wav">Ad 4</option>
      <option value="audio/ad/ad2.wav">Ad 2</option>
      <option value="audio/ad/ad3.wav">Ad 3</option>
      <option value="audio/ad/ad1.wav">Ad 1</option>
      <option value="audio/ad/ad5.wav">Ad 5</option>
      <option value="audio/ad/ad6.wav">Ad 6</option>
      <option value="audio/ad/ad7.wav">Ad 7</option>
      <option value="audio/ad/ad8.wav">Ad 8</option>
      <option value="audio/ad/none.wav">None</option>
      <option value="audio/ad/target.wav">Target Wav</option>
    </select>

    <select id="gap4" class="clip-dropdown">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br />

    <select id="ad5" class="clip-dropdown">
      <option value="audio/ad/ad5.wav">Ad 5</option>
      <option value="audio/ad/ad2.wav">Ad 2</option>
      <option value="audio/ad/ad3.wav">Ad 3</option>
      <option value="audio/ad/ad4.wav">Ad 4</option>
      <option value="audio/ad/ad5.wav">Ad 1</option>
      <option value="audio/ad/ad6.wav">Ad 6</option>
      <option value="audio/ad/ad7.wav">Ad 7</option>
      <option value="audio/ad/ad8.wav">Ad 8</option>
      <option value="audio/ad/none.wav">None</option>
      <option value="audio/ad/target.wav">Target Wav</option>
    </select>

    <select id="gap5"> class="clip-dropdown">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br />

    <select id="ad6" class="clip-dropdown">
      <option value="audio/ad/ad6.wav">Ad 6</option>
      <option value="audio/ad/ad2.wav">Ad 2</option>
      <option value="audio/ad/ad3.wav">Ad 3</option>
      <option value="audio/ad/ad4.wav">Ad 4</option>
      <option value="audio/ad/ad5.wav">Ad 5</option>
      <option value="audio/ad/ad6.wav">Ad 1</option>
      <option value="audio/ad/ad7.wav">Ad 7</option>
      <option value="audio/ad/ad8.wav">Ad 8</option>
      <option value="audio/ad/none.wav">None</option>
      <option value="audio/ad/target.wav">Target Wav</option>
    </select>

    <select id="gap6" class="clip-dropdown">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br />

    <select id="ad7" class="clip-dropdown">
      <option value="audio/ad/ad7.wav">Ad 7</option>
      <option value="audio/ad/ad2.wav">Ad 2</option>
      <option value="audio/ad/ad3.wav">Ad 3</option>
      <option value="audio/ad/ad4.wav">Ad 4</option>
      <option value="audio/ad/ad5.wav">Ad 5</option>
      <option value="audio/ad/ad6.wav">Ad 6</option>
      <option value="audio/ad/ad7.wav">Ad 1</option>
      <option value="audio/ad/ad8.wav">Ad 8</option>
      <option value="audio/ad/none.wav">None</option>
      <option value="audio/ad/target.wav">Target Wav</option>
    </select>

    <select id="gap7" class="clip-dropdown">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br /><br />

    <!-- Station Out -->
    <select id="station_out" class="clip-dropdown">
      <option value="audio/station/absolute.wav">Absolute</option>
      <option value="audio/station/sting2.wav">Sting 2</option>
      <option value="audio/ad/none.wav">None</option>
    </select>
  </div>

  <br />
  <label for="videoImage">Select Image for Video:</label>
  <select id="videoImage"> class="clip-dropdown">
    <option value="images/absolute.jpg">Absolute</option>
    <option value="images/cover1.jpg">Cover 1</option>
    <option value="images/cover2.jpg">Cover 2</option>
  </select>

  <br /><br />

  <button id="exportAudio">Export Audio</button>
  <button id="exportVideo">Export Video</button>

   <br /><br />

<video id="my-player" controls width="640" height="360" poster="" class="video-js">
  <source src="" type="video/webm" />
  Your browser does not support the video tag.
</video>

<br /><br />

  
<script>

import { createFFmpeg, fetchFile } from 'https://unpkg.com/@ffmpeg/ffmpeg@0.12.5/dist/ffmpeg.mjs';

const ffmpeg = createFFmpeg({ log: true });
await ffmpeg.load();
  
function getAudioContext() {
  if (!window.audioCtx) {
    window.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  return window.audioCtx;
}

async function buildSequence(context) {
  const dropdowns = document.querySelectorAll(".clip-dropdown");
  const selectedUrls = Array.from(dropdowns)
    .map(dropdown => dropdown.value)
    .filter(url => url); // skip empty

  if (selectedUrls.length === 0) {
    throw new Error("No audio clips selected.");
  }

  const buffers = await Promise.all(
    selectedUrls.map(async (url) => {
      const response = await fetch(url);
      const arrayBuffer = await response.arrayBuffer();
      return context.decodeAudioData(arrayBuffer);
    })
  );

  const totalLength = buffers.reduce((sum, b) => sum + b.length, 0);

  const output = context.createBuffer(1, totalLength, context.sampleRate);
  let offset = 0;

  for (const buffer of buffers) {
    output.getChannelData(0).set(buffer.getChannelData(0), offset);
    offset += buffer.length;
  }

  return output;
}

function bufferToWav(buffer) {
  const numChannels = buffer.numberOfChannels;
  const sampleRate = buffer.sampleRate;
  const format = 1; // PCM
  const bitDepth = 16;

  let result;
  if (numChannels === 2) {
    result = interleave(buffer.getChannelData(0), buffer.getChannelData(1));
  } else {
    result = buffer.getChannelData(0);
  }

  const bufferLength = result.length * 2 + 44;
  const wavBuffer = new ArrayBuffer(bufferLength);
  const view = new DataView(wavBuffer);

  /* RIFF identifier */
  writeString(view, 0, 'RIFF');
  /* file length */
  view.setUint32(4, 36 + result.length * 2, true);
  /* RIFF type */
  writeString(view, 8, 'WAVE');
  /* format chunk identifier */
  writeString(view, 12, 'fmt ');
  /* format chunk length */
  view.setUint32(16, 16, true);
  /* sample format (raw) */
  view.setUint16(20, format, true);
  /* channel count */
  view.setUint16(22, numChannels, true);
  /* sample rate */
  view.setUint32(24, sampleRate, true);
  /* byte rate (sample rate * block align) */
  view.setUint32(28, sampleRate * numChannels * bitDepth / 8, true);
  /* block align (channel count * bytes per sample) */
  view.setUint16(32, numChannels * bitDepth / 8, true);
  /* bits per sample */
  view.setUint16(34, bitDepth, true);
  /* data chunk identifier */
  writeString(view, 36, 'data');
  /* data chunk length */
  view.setUint32(40, result.length * 2, true);

  floatTo16BitPCM(view, 44, result);

  return new Blob([view], { type: 'audio/wav' });

  function writeString(view, offset, string) {
    for (let i = 0; i < string.length; i++) {
      view.setUint8(offset + i, string.charCodeAt(i));
    }
  }

  function floatTo16BitPCM(output, offset, input) {
    for (let i = 0; i < input.length; i++, offset += 2) {
      let s = Math.max(-1, Math.min(1, input[i]));
      s = s < 0 ? s * 0x8000 : s * 0x7FFF;
      output.setInt16(offset, s, true);
    }
  }

  function interleave(inputL, inputR) {
    const length = inputL.length + inputR.length;
    const result = new Float32Array(length);

    let index = 0;
    let inputIndex = 0;

    while (index < length) {
      result[index++] = inputL[inputIndex];
      result[index++] = inputR[inputIndex];
      inputIndex++;
    }
    return result;
  }
}

  
function downloadBlob(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.style = "display:none";
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(url);
  a.remove();
}

document.getElementById("exportAudio").addEventListener("click", async () => {
  const context = getAudioContext();
  if (!context) return;
  const buffer = await buildSequence(context);
  const wavBlob = bufferToWav(buffer);
  downloadBlob(wavBlob, "adbreak.wav");

  const { createFFmpeg, fetchFile } = FFmpeg;
const ffmpeg = createFFmpeg({ log: true });

document.getElementById("exportVideo").addEventListener("click", async () => {
  const ctx = getAudioContext();
  const audioBuffer = await buildSequence(ctx);
  const wavBlob = bufferToWaveBlob(audioBuffer);

  const imageFileName = document.getElementById("videoImage").value;
  const imageResponse = await fetch(imageFileName);
  const imageBlob = await imageResponse.blob();

  if (!ffmpeg.isLoaded()) {
    await ffmpeg.load();
  }

  ffmpeg.FS('writeFile', 'input.wav', await fetchFile(wavBlob));
  ffmpeg.FS('writeFile', 'cover.jpg', await fetchFile(imageBlob));

  // Combine WAV and JPG into a WebM video
  await ffmpeg.run(
    '-loop', '1',
    '-i', 'cover.jpg',
    '-i', 'input.wav',
    '-c:v', 'libvpx',
    '-c:a', 'libvorbis',
    '-shortest',
    '-movflags', 'faststart',
    '-pix_fmt', 'yuv420p',
    'output.webm'
  );

  const data = ffmpeg.FS('readFile', 'output.webm');
  const videoBlob = new Blob([data.buffer], { type: 'video/webm' });
  const videoUrl = URL.createObjectURL(videoBlob);

  const player = document.getElementById("my-player");
  player.src = videoUrl;
  player.load();
  player.play();
});

function bufferToWaveBlob(buffer) {
  const length = buffer.length * 2 + 44;
  const arrayBuffer = new ArrayBuffer(length);
  const view = new DataView(arrayBuffer);

  function writeString(view, offset, str) {
    for (let i = 0; i < str.length; i++) {
      view.setUint8(offset + i, str.charCodeAt(i));
    }
  }

  let offset = 0;
  writeString(view, offset, 'RIFF'); offset += 4;
  view.setUint32(offset, 36 + buffer.length * 2, true); offset += 4;
  writeString(view, offset, 'WAVE'); offset += 4;
  writeString(view, offset, 'fmt '); offset += 4;
  view.setUint32(offset, 16, true); offset += 4;
  view.setUint16(offset, 1, true); offset += 2;
  view.setUint16(offset, 1, true); offset += 2;
  view.setUint32(offset, buffer.sampleRate, true); offset += 4;
  view.setUint32(offset, buffer.sampleRate * 2, true); offset += 4;
  view.setUint16(offset, 2, true); offset += 2;
  view.setUint16(offset, 16, true); offset += 2;
  writeString(view, offset, 'data'); offset += 4;
  view.setUint32(offset, buffer.length * 2, true); offset += 4;

  const channelData = buffer.getChannelData(0);
  for (let i = 0; i < channelData.length; i++, offset += 2) {
    const s = Math.max(-1, Math.min(1, channelData[i]));
    view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
  }

  return new Blob([arrayBuffer], { type: 'audio/wav' });
}

});
</script>

</body> </html>
