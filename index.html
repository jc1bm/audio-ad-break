<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ad In Situ Maker</title>
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>
</head>
<body>
  <h1>Ad In Situ Maker 8</h1>

  <!-- Your existing dropdowns -->
  <div id="selectors">
    <!-- Station In -->
    <select id="station_in">
      <option value="audio/station/absolute.wav">Absolute</option>
      <option value="audio/station/sting2.wav">Sting 2</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <!-- Gap and Ad Selects -->
    <select id="gap0">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br /><br />

    <select id="ad1">
      <option value="audio/ad/ad1.wav">Ad 1</option>
      <option value="audio/ad/ad2.wav">Ad 2</option>
      <option value="audio/ad/ad3.wav">Ad 3</option>
      <option value="audio/ad/ad4.wav">Ad 4</option>
      <option value="audio/ad/ad5.wav">Ad 5</option>
      <option value="audio/ad/ad6.wav">Ad 6</option>
      <option value="audio/ad/ad7.wav">Ad 7</option>
      <option value="audio/ad/ad8.wav">Ad 8</option>
      <option value="audio/ad/none.wav">None</option>
      <option value="audio/ad/target.wav">Target Wav</option>
    </select>

    <select id="gap1">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br />

    <select id="ad2">
      <option value="audio/ad/ad2.wav">Ad 2</option>
      <option value="audio/ad/ad1.wav">Ad 1</option>
      <option value="audio/ad/ad3.wav">Ad 3</option>
      <option value="audio/ad/ad4.wav">Ad 4</option>
      <option value="audio/ad/ad5.wav">Ad 5</option>
      <option value="audio/ad/ad6.wav">Ad 6</option>
      <option value="audio/ad/ad7.wav">Ad 7</option>
      <option value="audio/ad/ad8.wav">Ad 8</option>
      <option value="audio/ad/none.wav">None</option>
      <option value="audio/ad/target.wav">Target Wav</option>
    </select>

    <select id="gap2">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br />

    <select id="ad3">
      <option value="audio/ad/ad3.wav">Ad 3</option>
      <option value="audio/ad/ad2.wav">Ad 2</option>
      <option value="audio/ad/ad1.wav">Ad 1</option>
      <option value="audio/ad/ad4.wav">Ad 4</option>
      <option value="audio/ad/ad5.wav">Ad 5</option>
      <option value="audio/ad/ad6.wav">Ad 6</option>
      <option value="audio/ad/ad7.wav">Ad 7</option>
      <option value="audio/ad/ad8.wav">Ad 8</option>
      <option value="audio/ad/none.wav">None</option>
      <option value="audio/ad/target.wav">Target Wav</option>
    </select>

    <select id="gap3">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br />

    <select id="ad4">
      <option value="audio/ad/ad4.wav">Ad 4</option>
      <option value="audio/ad/ad2.wav">Ad 2</option>
      <option value="audio/ad/ad3.wav">Ad 3</option>
      <option value="audio/ad/ad1.wav">Ad 1</option>
      <option value="audio/ad/ad5.wav">Ad 5</option>
      <option value="audio/ad/ad6.wav">Ad 6</option>
      <option value="audio/ad/ad7.wav">Ad 7</option>
      <option value="audio/ad/ad8.wav">Ad 8</option>
      <option value="audio/ad/none.wav">None</option>
      <option value="audio/ad/target.wav">Target Wav</option>
    </select>

    <select id="gap4">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br />

    <select id="ad5">
      <option value="audio/ad/ad5.wav">Ad 5</option>
      <option value="audio/ad/ad2.wav">Ad 2</option>
      <option value="audio/ad/ad3.wav">Ad 3</option>
      <option value="audio/ad/ad4.wav">Ad 4</option>
      <option value="audio/ad/ad5.wav">Ad 1</option>
      <option value="audio/ad/ad6.wav">Ad 6</option>
      <option value="audio/ad/ad7.wav">Ad 7</option>
      <option value="audio/ad/ad8.wav">Ad 8</option>
      <option value="audio/ad/none.wav">None</option>
      <option value="audio/ad/target.wav">Target Wav</option>
    </select>

    <select id="gap5">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br />

    <select id="ad6">
      <option value="audio/ad/ad6.wav">Ad 6</option>
      <option value="audio/ad/ad2.wav">Ad 2</option>
      <option value="audio/ad/ad3.wav">Ad 3</option>
      <option value="audio/ad/ad4.wav">Ad 4</option>
      <option value="audio/ad/ad5.wav">Ad 5</option>
      <option value="audio/ad/ad6.wav">Ad 1</option>
      <option value="audio/ad/ad7.wav">Ad 7</option>
      <option value="audio/ad/ad8.wav">Ad 8</option>
      <option value="audio/ad/none.wav">None</option>
      <option value="audio/ad/target.wav">Target Wav</option>
    </select>

    <select id="gap6">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br />

    <select id="ad7">
      <option value="audio/ad/ad7.wav">Ad 7</option>
      <option value="audio/ad/ad2.wav">Ad 2</option>
      <option value="audio/ad/ad3.wav">Ad 3</option>
      <option value="audio/ad/ad4.wav">Ad 4</option>
      <option value="audio/ad/ad5.wav">Ad 5</option>
      <option value="audio/ad/ad6.wav">Ad 6</option>
      <option value="audio/ad/ad7.wav">Ad 1</option>
      <option value="audio/ad/ad8.wav">Ad 8</option>
      <option value="audio/ad/none.wav">None</option>
      <option value="audio/ad/target.wav">Target Wav</option>
    </select>

    <select id="gap7">
      <option value="audio/ad/gap.wav">Gap</option>
      <option value="audio/ad/none.wav">None</option>
    </select>

    <br /><br />

    <!-- Station Out -->
    <select id="station_out">
      <option value="audio/station/absolute.wav">Absolute</option>
      <option value="audio/station/sting2.wav">Sting 2</option>
      <option value="audio/ad/none.wav">None</option>
    </select>
  </div>

  <br />
  <label for="videoImage">Select Image for Video:</label>
  <select id="videoImage">
    <option value="images/absolute.jpg">Absolute</option>
    <option value="images/cover1.jpg">Cover 1</option>
    <option value="images/cover2.jpg">Cover 2</option>
  </select>

  <br /><br />

  <button id="exportAudio">Export Audio</button>
  <button id="exportVideo">Export Video</button>

<script>
  let audioContext;

  function getAudioContext() {
    if (!audioContext) {
      if (window.AudioContext || window.webkitAudioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      } else {
        alert("Web Audio API is not supported in this browser.");
        return null;
      }
    }
    return audioContext;
  }

  async function fetchAudioBuffer(url, context) {
    const response = await fetch(url);
    const arrayBuffer = await response.arrayBuffer();
    return await context.decodeAudioData(arrayBuffer);
  }

  async function buildSequence(context) {
    const selectorIds = [
      "station_in", "gap0", "ad1", "gap1", "ad2", "gap2", "ad3", "gap3",
      "ad4", "gap4", "ad5", "gap5", "ad6", "gap6", "ad7", "gap7", "station_out"
    ];

    const audioBuffers = [];
    for (const id of selectorIds) {
      const value = document.getElementById(id).value;
      if (value === "audio/ad/none.wav") continue;
      const buffer = await fetchAudioBuffer(value, context);
      audioBuffers.push(buffer);
    }

    const totalLength = audioBuffers.reduce((acc, b) => acc + b.length, 0);
    const numChannels = audioBuffers[0] ? audioBuffers[0].numberOfChannels : 2;
    const sampleRate = audioBuffers[0] ? audioBuffers[0].sampleRate : 44100;
    const outputBuffer = context.createBuffer(numChannels, totalLength, sampleRate);

    let offset = 0;
    for (const buffer of audioBuffers) {
      for (let channel = 0; channel < numChannels; channel++) {
        const outputData = outputBuffer.getChannelData(channel);
        const inputData = buffer.getChannelData(channel % buffer.numberOfChannels);
        outputData.set(inputData, offset);
      }
      offset += buffer.length;
    }

    return outputBuffer;
  }

  function bufferToWav(buffer) {
    const numChannels = buffer.numberOfChannels;
    const sampleRate = buffer.sampleRate;
    const format = 1; // PCM
    const bitDepth = 16;

    let samples;
    if (numChannels === 2) {
      const left = buffer.getChannelData(0);
      const right = buffer.getChannelData(1);
      samples = interleave(left, right);
    } else {
      samples = buffer.getChannelData(0);
    }

    const dataLength = samples.length * (bitDepth / 8);
    const bufferLength = 44 + dataLength;
    const wavBuffer = new ArrayBuffer(bufferLength);
    const view = new DataView(wavBuffer);

    writeString(view, 0, 'RIFF');
    view.setUint32(4, 36 + dataLength, true);
    writeString(view, 8, 'WAVE');
    writeString(view, 12, 'fmt ');
    view.setUint32(16, 16, true);
    view.setUint16(20, format, true);
    view.setUint16(22, numChannels, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * numChannels * bitDepth / 8, true);
    view.setUint16(32, numChannels * bitDepth / 8, true);
    view.setUint16(34, bitDepth, true);
    writeString(view, 36, 'data');
    view.setUint32(40, dataLength, true);

    floatTo16BitPCM(view, 44, samples);
    return new Blob([view], { type: 'audio/wav' });
  }

  function writeString(view, offset, string) {
    for (let i = 0; i < string.length; i++) {
      view.setUint8(offset + i, string.charCodeAt(i));
    }
  }

  function floatTo16BitPCM(output, offset, input) {
    for (let i = 0; i < input.length; i++, offset += 2) {
      let s = Math.max(-1, Math.min(1, input[i]));
      s = s < 0 ? s * 0x8000 : s * 0x7FFF;
      output.setInt16(offset, s, true);
    }
  }

  function interleave(left, right) {
    const length = left.length + right.length;
    const result = new Float32Array(length);
    let inputIndex = 0;
    for (let index = 0; index < length;) {
      result[index++] = left[inputIndex];
      result[index++] = right[inputIndex];
      inputIndex++;
    }
    return result;
  }

  function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.style = "display:none";
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(url);
    a.remove();
  }

  document.getElementById("exportAudio").addEventListener("click", async () => {
    const context = getAudioContext();
    if (!context) return;
    const buffer = await buildSequence(context);
    const wavBlob = bufferToWav(buffer);
    downloadBlob(wavBlob, "adbreak.wav");
  });

  document.getElementById("exportVideo").addEventListener("click", async () => {
    const context = getAudioContext();
    if (!context) return;

    const buffer = await buildSequence(context);
    const wavBlob = bufferToWav(buffer);
    const wavArrayBuffer = await wavBlob.arrayBuffer();

    const { createFFmpeg } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });
    await ffmpeg.load();

    ffmpeg.FS('writeFile', 'audio.wav', new Uint8Array(wavArrayBuffer));

    const imageUrl = document.getElementById("videoImage").value;
    const imageResponse = await fetch(imageUrl);
    const imageData = new Uint8Array(await imageResponse.arrayBuffer());
    const imageName = 'cover.jpg';
    ffmpeg.FS('writeFile', imageName, imageData);

    await ffmpeg.run(
      '-loop', '1',
      '-i', imageName,
      '-i', 'audio.wav',
      '-c:v', 'libx264',
      '-c:a', 'aac',
      '-b:a', '192k',
      '-shortest',
      '-pix_fmt', 'yuv420p',
      'output.mp4'
    );

    const data = ffmpeg.FS('readFile', 'output.mp4');
    const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
    downloadBlob(videoBlob, 'adbreak-video.mp4');
  });
</script>
</body>
</html>
